<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retirement Income Calculator</title>
    <style>
        /* ===== RESET & GLOBAL ===== */
        *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(135deg,#E8F4F8 0%,#F0E8FF 100%);min-height:100vh;padding:20px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.container{max-width:2000px;margin:0 auto}

        /* ===== HEADER ===== */
        .header{text-align:center;margin-bottom:40px}h1{color:#1A237E;font-size:36px;font-weight:600;margin-bottom:12px}.subtitle{color:#1A237E;font-size:18px;margin-bottom:24px}.mode-toggle{display:flex;justify-content:center;gap:12px}

        /* ===== MAIN LAYOUT ===== */
        .layout-wrapper{display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-top:32px}
        .layout-wrapper.couple{grid-template-columns:1fr;gap:32px}
        .all-inputs{display:grid;grid-template-columns:1fr;gap:32px}
        .all-inputs.couple{grid-template-columns:1fr 1fr 1fr;gap:32px}
        .results-section{grid-column:auto}
        .layout-wrapper.couple .results-section{grid-column:1/-1}

        /* ===== CARD ===== */
        .card{background:white;border-radius:12px;padding:32px;box-shadow:0 4px 12px rgba(0,0,0,.1);border:1px solid #F0F0F0}.card h2{color:#1A237E;font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:20px;border-bottom:2px solid #F0F0F0;padding-bottom:12px}.card h3{color:#1A237E;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin:20px 0 12px;cursor:pointer;user-select:none;display:flex;align-items:center;gap:8px;background:#F5F6FA;padding:12px;border-radius:6px;margin-left:-12px;margin-right:-12px}.card h3:first-of-type{margin-top:0}.toggle{margin-left:auto;font-size:12px;transition:transform .2s}.card h3.collapsed~*{display:none}.card h3.collapsed .toggle{transform:rotate(-90deg)}

        /* ===== FORMS ===== */
        .form-group{margin-bottom:16px}label{display:block;margin-bottom:6px;color:#212121;font-weight:500;font-size:12px;text-transform:uppercase;letter-spacing:.3px}input,select{width:100%;padding:10px 12px;border:2px solid #E8E8E8;border-radius:8px;font-size:14px;color:#212121;transition:all .2s}input:focus,select:focus{outline:none;border-color:#1A237E;box-shadow:0 0 0 3px rgba(26,35,126,.1)}.input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.input-with-unit{display:flex}.input-with-unit input{border-radius:8px 0 0 8px}.unit{display:flex;align-items:center;padding:0 12px;background:#F5F6FA;border:2px solid #E8E8E8;border-left:none;border-radius:0 8px 8px 0;font-weight:600;color:#37474F;font-size:12px}.note{font-size:10px;color:#999;margin-top:4px}.label-note{font-size:11px;color:#999;text-transform:none;letter-spacing:normal;font-weight:400;margin-top:4px}

        /* ===== BUTTONS ===== */
        .toggle-group{display:flex;gap:8px;margin-top:6px}.toggle-btn{flex:1;padding:8px;border:2px solid #E8E8E8;background:white;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;cursor:pointer;transition:all .2s;color:#37474F}.toggle-btn.active{background:#1A237E;color:white;border-color:#1A237E}.toggle-btn:hover{border-color:#1A237E}.reset-btn{width:100%;background:#F5F6FA;color:#37474F;border:2px solid #E8E8E8;padding:12px;margin-top:24px;border-radius:8px;font-weight:600;font-size:12px;cursor:pointer;text-transform:uppercase;transition:all .2s}.reset-btn:hover{background:#EEEFF5}.add-period-btn{background:#01796F;color:white;padding:10px 16px;font-size:12px;width:auto;margin-top:10px;border:none;border-radius:8px;cursor:pointer;transition:all .2s}.add-period-btn:hover{background:#016156}.remove-period-btn{background:#E74C3C;color:white;padding:8px 12px;font-size:11px;width:auto;margin-left:8px;border:none;border-radius:8px;cursor:pointer;transition:all .2s}.remove-period-btn:hover{background:#C0392B}

        /* ===== RESULTS ===== */
        .result-item{background:#F5F6FA;padding:16px;border-radius:8px;margin-bottom:12px;border-left:4px solid #01796F}.result-label{color:#757575;font-size:11px;text-transform:uppercase;letter-spacing:.4px;font-weight:600}.result-value{color:#1A237E;font-size:28px;font-weight:700;margin-top:4px;font-family:monospace}.result-subtext{color:#999;font-size:11px;margin-top:4px}

        /* ===== BREAKDOWN ===== */
        .breakdown{border:2px solid #E8E8E8;border-radius:8px;margin-top:12px;overflow:hidden}.breakdown-header{padding:12px;background:#F5F6FA;cursor:pointer;display:flex;justify-content:space-between;font-weight:600;color:#1A237E;user-select:none}.breakdown-header:hover{background:#EEEFF5}.breakdown-header.expanded{background:#1A237E;color:white}.breakdown-toggle{transition:transform .2s}.breakdown-header.expanded .breakdown-toggle{transform:rotate(180deg)}.breakdown-content{display:none;padding:12px;border-top:1px solid #E8E8E8}.breakdown-content.show{display:block}.breakdown-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #E8E8E8;font-size:12px}.breakdown-item:last-child{border-bottom:none}

        /* ===== TABLE ===== */
        table{width:100%;margin-top:16px;border-collapse:collapse;font-size:11px}th{background:#F5F6FA;padding:8px;text-align:right;font-weight:600;color:#1A237E;border-bottom:2px solid #E8E8E8}th:first-child{text-align:left}td{padding:8px;border-bottom:1px solid #F0F0F0;text-align:right}td:first-child{text-align:left}

        /* ===== UTILITY ===== */
        .info{background:#E3F2FD;border-left:4px solid #01796F;padding:12px;border-radius:8px;margin-top:16px;color:#004085;font-size:12px}.error{background:#FFEBEE;border-left:4px solid #E74C3C;padding:12px;border-radius:8px;color:#C62828;margin-bottom:16px}.divider{border-top:1px solid #F0F0F0;margin:20px 0}.placeholder{text-align:center;padding:40px 20px;color:#999}.couple-results{display:none}.couple-results.visible{display:block}.partner-card{display:none}.partner-card.visible{display:block}.shared-settings{display:none}.shared-settings.visible{display:block}.your-settings{display:none}.your-settings.individual-mode{display:block}.your-settings.couple-mode{display:block}.individual-only{display:block}.couple-hidden{display:none}

        /* ===== PERIOD STYLING ===== */
        .nested-form-group{background:#FAFAFA;padding:16px;border-radius:6px;margin-top:12px;border-left:3px solid #01796F}.period{background:#FFFFFF;border:1px solid #E8E8E8;border-radius:8px;padding:16px;margin-bottom:12px}.period-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.period-title{font-weight:600;color:#1A237E;font-size:13px}.period-inputs{display:grid;grid-template-columns:1fr 1fr;gap:12px}

        /* ===== RESPONSIVE ===== */
        @media(max-width:1600px){.layout-wrapper{grid-template-columns:1fr}.all-inputs.couple{grid-template-columns:1fr 1fr}}
        @media(max-width:1200px){.all-inputs.couple{grid-template-columns:1fr}.input-row{grid-template-columns:1fr}}
        @media(max-width:800px){.card{padding:20px}h1{font-size:28px}.input-with-unit{flex-direction:column}.input-with-unit input{border-radius:8px}.unit{border-radius:8px;border-left:2px solid #E8E8E8}}
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== HEADER SECTION ===== -->
        <div class="header">
            <h1>Retirement Income Calculator</h1>
            <p class="subtitle">Calculate your projected KiwiSaver balance and retirement income</p>
            <div class="mode-toggle">
                <button class="toggle-btn active" id="individualBtn">Individual</button>
                <button class="toggle-btn" id="coupleBtn">Couple</button>
            </div>
        </div>

        <!-- ===== MAIN CONTENT AREA ===== -->
        <div class="layout-wrapper" id="layoutWrapper">
            <!-- ===== INPUTS SECTION ===== -->
            <div class="all-inputs" id="allInputs">
                <!-- YOU: Basic KiwiSaver inputs -->
                <div class="card" id="yourCard">
                    <h2>Your Details</h2>
                    <div class="input-row">
                        <div class="form-group"><label>Current Age</label><input type="number" id="age" value="35" min="18" max="100"></div>
                        <div class="form-group"><label>Withdrawal Age</label><input type="number" id="withdrawalAge" value="65" min="60" max="100"></div>
                    </div>
                    <div class="input-row">
                        <div class="form-group"><label>KiwiSaver Balance</label><div class="input-with-unit"><input type="text" id="currentBalance" value="5,000"><div class="unit">$</div></div></div>
                        <div class="form-group"><label>Annual Gross Income</label><div class="input-with-unit"><input type="text" id="annualIncome" value="80,000"><div class="unit">$</div></div></div>
                    </div>
                    <div class="input-row">
                        <div class="form-group"><label>Member Contribution</label><div class="input-with-unit"><input type="number" id="memberRate" value="4" min="0" max="100" step="0.1"><div class="unit">%</div></div></div>
                        <div class="form-group"><label>Employer Contribution</label><div class="input-with-unit"><input type="number" id="employerRate" value="4" min="0" max="100" step="0.1"><div class="unit">%</div></div></div>
                    </div>

                    <!-- Settings section: shown in individual mode and couple mode -->
                    <div class="your-settings individual-mode couple-mode" id="yourSettings">
                        <!-- Early Withdrawals and Suspensions -->
                        <h3 onclick="toggleSection(this)">Early Withdrawals and Suspensions <span class="toggle">▼</span></h3>
                        
                        <!-- Temporary Rate Reduction -->
                        <div class="form-group">
                            <label>Temporary Rate Reduction</label>
                            <p class="label-note">Reduce contributions to 3% for specific periods</p>
                            <div class="toggle-group">
                                <button type="button" class="toggle-btn active" id="reductionOff">No</button>
                                <button type="button" class="toggle-btn" id="reductionOn">Yes</button>
                            </div>
                        </div>
                        <div id="reductionDetails" class="nested-form-group" style="display: none;">
                            <div id="reductionPeriodsContainer"></div>
                            <button class="add-period-btn" id="addPeriodBtn">+ Add Another Period</button>
                        </div>

                        <!-- Savings Suspension -->
                        <div class="form-group">
                            <label>Savings Suspension</label>
                            <p class="label-note">Pause contributions for specific periods</p>
                            <div class="toggle-group">
                                <button type="button" class="toggle-btn active" id="suspensionOff">No</button>
                                <button type="button" class="toggle-btn" id="suspensionOn">Yes</button>
                            </div>
                        </div>
                        <div id="suspensionDetails" class="nested-form-group" style="display: none;">
                            <div id="suspensionPeriodsContainer"></div>
                            <button class="add-period-btn" id="addSuspensionBtn">+ Add Another Suspension</button>
                        </div>

                        <!-- First Home Withdrawal -->
                        <div class="form-group">
                            <label>First Home Withdrawal</label>
                            <p class="label-note">Withdraw funds for first home purchase</p>
                            <div class="toggle-group">
                                <button type="button" class="toggle-btn active" id="homeStartOff">No</button>
                                <button type="button" class="toggle-btn" id="homeStartOn">Yes</button>
                            </div>
                        </div>
                        <div id="homeStartDetails" class="nested-form-group" style="display: none;">
                            <div class="input-row">
                                <div class="form-group">
                                    <label for="homeStartYear">Year of Withdrawal</label>
                                    <input type="number" id="homeStartYear" min="1" value="5" onchange="updateMaxHomeWithdrawal()">
                                    <p class="label-note">1 = next year, 2 = year after, etc.</p>
                                </div>
                                <div class="form-group">
                                    <label for="homeStartAmount">Amount to Withdraw</label>
                                    <div class="input-with-unit"><input type="text" id="homeStartAmount" value="" readonly><div class="unit">$</div></div>
                                    <p class="label-note">Auto-filled with maximum available (balance minus $1,000)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsible: Investment & Assumptions section (only in individual mode) -->
                        <h3 class="individual-only" onclick="toggleSection(this)">Investment & Assumptions <span class="toggle">▼</span></h3>
                        <div class="section-content individual-only" style="display: block;">
                            <div class="form-group"><label>Investment Fund</label><select id="strategy">
                                <option value="defensive">Defensive</option>
                                <option value="conservative">Conservative</option>
                                <option value="balanced" selected>Balanced</option>
                                <option value="growth">Growth</option>
                                <option value="aggressive">Aggressive</option>
                            </select></div>
                            
                            <div class="input-row">
                                <div class="form-group"><label>Return After 65</label><div class="input-with-unit"><input type="number" id="retirementReturn" value="2.0" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                                <div class="form-group"><label>Annual Wage Growth</label><div class="input-with-unit"><input type="number" id="wageGrowth" value="3.5" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                            </div>
                            <div class="input-row">
                                <div class="form-group"><label>Inflation Rate</label><div class="input-with-unit"><input type="number" id="inflationRate" value="2.0" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                                <div class="form-group"><label>Display Results</label><div class="toggle-group">
                                    <button class="toggle-btn active inflation-toggle" data-value="true">Real</button>
                                    <button class="toggle-btn inflation-toggle" data-value="false">Nominal</button>
                                </div></div>
                            </div>
                            <div class="form-group"><label>Fiscal Drag (ESCT)</label><div class="toggle-group">
                                <button class="toggle-btn active fiscal-toggle" data-value="true">Yes</button>
                                <button class="toggle-btn fiscal-toggle" data-value="false">No</button>
                            </div></div>

                            <!-- Collapsible: NZ Super settings section -->
                            <h3 onclick="toggleSection(this)">NZ Super <span class="toggle">▼</span></h3>
                            <div class="input-row">
                                <div class="form-group"><label>Eligibility Age</label><input type="number" id="nzSuperAge" value="65" min="60" max="100"></div>
                                <div class="form-group"><label>Annual Rate</label><div class="input-with-unit"><input type="text" id="nzSuperAnnual" value="26,689"><div class="unit">$</div></div><p class="note">2026 (single)</p></div>
                            </div>
                            <div class="form-group"><label>Indexation</label><select id="nzSuperIndexation">
                                <option value="none">None</option>
                                <option value="cpi" selected>CPI</option>
                                <option value="wage">Wage</option>
                                <option value="hybrid">Hybrid</option>
                            </select></div>

                            <!-- Collapsible: Retirement income withdrawal rules -->
                            <h3 onclick="toggleSection(this)">Retirement Income <span class="toggle">▼</span></h3>
                            <div class="form-group"><label>Withdrawal Rule</label><select id="incomeRule">
                                <option value="4percent" selected>4% Rule</option>
                                <option value="6percent">6% Rule</option>
                                <option value="fixed-date">Fixed (Age 90)</option>
                                <option value="life-expectancy">Life Expectancy</option>
                            </select></div>

                            <button class="reset-btn" id="resetBtn">Reset All</button>
                        </div>
                    </div>
                </div>

                <!-- PARTNER: Hidden in individual mode, visible in couple mode -->
                <div class="card partner-card" id="partnerCard">
                    <h2>Partner Details</h2>
                    <div class="input-row">
                        <div class="form-group"><label>Current Age</label><input type="number" id="agePartner" value="35" min="18" max="100"></div>
                        <div class="form-group"><label>Withdrawal Age</label><input type="number" id="withdrawalAgePartner" value="65" min="60" max="100"></div>
                    </div>
                    <div class="input-row">
                        <div class="form-group"><label>KiwiSaver Balance</label><div class="input-with-unit"><input type="text" id="currentBalancePartner" value="5,000"><div class="unit">$</div></div></div>
                        <div class="form-group"><label>Annual Gross Income</label><div class="input-with-unit"><input type="text" id="annualIncomePartner" value="80,000"><div class="unit">$</div></div></div>
                    </div>
                    <div class="input-row">
                        <div class="form-group"><label>Member Contribution</label><div class="input-with-unit"><input type="number" id="memberRatePartner" value="4" min="0" max="100" step="0.1"><div class="unit">%</div></div></div>
                        <div class="form-group"><label>Employer Contribution</label><div class="input-with-unit"><input type="number" id="employerRatePartner" value="4" min="0" max="100" step="0.1"><div class="unit">%</div></div></div>
                    </div>
                    <div class="form-group"><label>Investment Strategy</label><select id="strategyPartner">
                        <option value="defensive">Defensive</option>
                        <option value="conservative">Conservative</option>
                        <option value="balanced" selected>Balanced</option>
                        <option value="growth">Growth</option>
                        <option value="aggressive">Aggressive</option>
                    </select></div>
                </div>

                <!-- SHARED SETTINGS: Shown in couple mode -->
                <div class="card shared-settings" id="sharedSettingsCard">
                    <h2>Shared Settings</h2>

                    <!-- Collapsible: Investment & Assumptions section -->
                    <h3 onclick="toggleSection(this)">Investment & Assumptions <span class="toggle">▼</span></h3>
                    <div class="form-group"><label>Investment Fund</label><select id="strategyShared">
                        <option value="defensive">Defensive</option>
                        <option value="conservative">Conservative</option>
                        <option value="balanced" selected>Balanced</option>
                        <option value="growth">Growth</option>
                        <option value="aggressive">Aggressive</option>
                    </select></div>
                    
                    <div class="input-row">
                        <div class="form-group"><label>Return After 65</label><div class="input-with-unit"><input type="number" id="retirementReturnShared" value="2.0" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                        <div class="form-group"><label>Annual Wage Growth</label><div class="input-with-unit"><input type="number" id="wageGrowthShared" value="3.5" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                    </div>
                    <div class="input-row">
                        <div class="form-group"><label>Inflation Rate</label><div class="input-with-unit"><input type="number" id="inflationRateShared" value="2.0" min="0" max="10" step="0.1"><div class="unit">%</div></div></div>
                        <div class="form-group"><label>Display Results</label><div class="toggle-group">
                            <button class="toggle-btn active inflation-toggle" data-value="true">Real</button>
                            <button class="toggle-btn inflation-toggle" data-value="false">Nominal</button>
                        </div></div>
                    </div>
                    <div class="form-group"><label>Fiscal Drag (ESCT)</label><div class="toggle-group">
                        <button class="toggle-btn active fiscal-toggle" data-value="true">Yes</button>
                        <button class="toggle-btn fiscal-toggle" data-value="false">No</button>
                    </div></div>

                    <!-- Collapsible: NZ Super settings -->
                    <h3 onclick="toggleSection(this)">NZ Super <span class="toggle">▼</span></h3>
                    <div class="input-row">
                        <div class="form-group"><label>Eligibility Age</label><input type="number" id="nzSuperAgeShared" value="65" min="60" max="100"></div>
                        <div class="form-group"><label>Annual Rate</label><div class="input-with-unit"><input type="text" id="nzSuperAnnualShared" value="40,476"><div class="unit">$</div></div><p class="note">2026 (couple)</p></div>
                    </div>
                    <div class="form-group"><label>Indexation</label><select id="nzSuperIndexationShared">
                        <option value="none">None</option>
                        <option value="cpi" selected>CPI</option>
                        <option value="wage">Wage</option>
                        <option value="hybrid">Hybrid</option>
                    </select></div>

                    <!-- Collapsible: Retirement income withdrawal rules -->
                    <h3 onclick="toggleSection(this)">Retirement Income <span class="toggle">▼</span></h3>
                    <div class="form-group"><label>Withdrawal Rule</label><select id="incomeRuleShared">
                        <option value="4percent" selected>4% Rule</option>
                        <option value="6percent">6% Rule</option>
                        <option value="fixed-date">Fixed (Age 90)</option>
                        <option value="life-expectancy">Life Expectancy</option>
                    </select></div>

                    <button class="reset-btn" id="resetBtnShared">Reset All</button>
                </div>
            </div>

            <!-- ===== RESULTS SECTION ===== -->
            <div class="card results-section" id="resultsCard">
                <h2>Results</h2>
                <div id="errorMessage"></div>
                <div id="resultsContent" style="display:none">
                    <div class="result-item">
                        <div class="result-label">Projected KiwiSaver Balance</div>
                        <div class="result-value" id="projectedBalance">$0.00</div>
                        <div class="result-subtext" id="withdrawalAgeDisplay"></div>
                        <div class="breakdown">
                            <div class="breakdown-header" onclick="toggleBreakdown(this)"><span>Balance Breakdown</span> <span class="breakdown-toggle">▼</span></div>
                            <div class="breakdown-content">
                                <div class="breakdown-item"><span>Starting</span><span id="breakdownStarting">$0.00</span></div>
                                <div class="breakdown-item"><span>+ Contributions</span><span id="breakdownMember">$0.00</span></div>
                                <div class="breakdown-item"><span>+ Employer</span><span id="breakdownEmployer">$0.00</span></div>
                                <div class="breakdown-item"><span>+ Government</span><span id="breakdownGovernment">$0.00</span></div>
                                <div class="breakdown-item"><span>+ Returns</span><span id="breakdownReturns">$0.00</span></div>
                                <div class="breakdown-item" id="homeStartBreakdownItem" style="display: none;"><span>- First Home</span><span id="breakdownHomeStart">$0.00</span></div>
                            </div>
                        </div>
                    </div>

                    <div id="coupleResults" class="couple-results">
                        <div class="divider"></div>
                        <div class="result-item">
                            <div class="result-label">Partner Balance</div>
                            <div class="result-value" id="projectedBalancePartner">$0.00</div>
                            <div class="result-subtext">At age <span id="withdrawalAgeDisplayPartner">65</span></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Combined Balance</div>
                            <div class="result-value" id="combinedBalance">$0.00</div>
                        </div>
                    </div>

                    <div style="background:#E3F2FD;border-left:4px solid #01796F;padding:12px;border-radius:8px;margin-top:12px;color:#004085;font-size:12px">
                        <div style="color:#757575;font-weight:600;text-transform:uppercase;margin-bottom:6px">Projected NZ Super (Annual)</div>
                        <div style="color:#1A237E;font-size:24px;font-weight:700;font-family:monospace" id="nzSuperValue">$0.00</div>
                        <div style="margin-top:6px" id="nzSuperIndexationDetails"></div>
                    </div>

                    <div class="divider"></div>
                    <h3 style="margin:0 0 12px;color:#1A237E;font-size:12px;font-weight:600;border:none;background:none;padding:0;text-transform:uppercase">Annual Retirement Income</h3>
                    <table>
                        <thead><tr><th>Age</th><th>KiwiSaver</th><th>NZ Super</th><th>Total</th><th>Repl %</th></tr></thead>
                        <tbody id="incomeTable"></tbody>
                    </table>

                    <div class="info">
                        <strong>ℹ️ Estimates only</strong> – Actual returns vary by market performance.
                    </div>
                </div>
                <div id="resultsPlaceholder" class="placeholder">Fill in your details and results will appear here</div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIG CONSTANTS =====
        const FUND_RATES = {
            defensive: { 28: 0.015, 17.5: 0.016, 10.5: 0.019 },
            conservative: { 28: 0.025, 17.5: 0.027, 10.5: 0.030 },
            balanced: { 28: 0.035, 17.5: 0.038, 10.5: 0.041 },
            growth: { 28: 0.045, 17.5: 0.049, 10.5: 0.052 },
            aggressive: { 28: 0.055, 17.5: 0.060, 10.5: 0.063 }
        };
        
        const GOVT_ANNUAL_CAP=260.72;
        const GOVT_RATE=.25;
        const NZ_SUPER={single:26689,couple:40476};
        const INCOME_TAX_BRACKETS=[{threshold:15600,rate:.105},{threshold:53500,rate:.175},{threshold:78100,rate:.30},{threshold:180000,rate:.33},{threshold:1/0,rate:.39}];
        const ESCT_BRACKETS=[{threshold:48e3,rate:.105},{threshold:70e3,rate:.175},{threshold:180e3,rate:.21},{threshold:1/0,rate:0}];
        const FIRST_HOME_MIN_REMAINING=1000;
        
        // ===== APP STATE =====
        let coupleMode=false, fiscalDrag=true, inflation=true;
        let reductionEnabled=false, suspensionEnabled=false, homeStartEnabled=false;
        let reductionPeriods=[{startYear:1,duration:1}], suspensionPeriods=[{startYear:1,duration:1}];

        // ===== UTILITY FUNCTIONS =====
        const fmt=v=>'$'+v.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,',');
        const clean=v=>(v+'').replace(/,/g,'');
        const g=(id)=>document.getElementById(id);
        
        // Get PIE tax rate based on income level
        function getPIETaxRate(grossIncome){
            if(grossIncome<=15600) return 10.5;
            if(grossIncome<=78100) return 17.5;
            return 28;
        }
        
        const getRate=(strategy,pieRate)=>FUND_RATES[strategy][pieRate]||0.03;

        // Calculate income tax on gross income
        function calcIncomeTax(grossIncome){
            let tax=0;
            let prevThreshold=0;
            for(let bracket of INCOME_TAX_BRACKETS){
                if(grossIncome<=prevThreshold) break;
                const taxableInThisBracket=Math.min(grossIncome,bracket.threshold)-prevThreshold;
                tax+=taxableInThisBracket*bracket.rate;
                prevThreshold=bracket.threshold;
            }
            return tax;
        }

        // Get ESCT rate for given income
        const getEsctRate=inc=>ESCT_BRACKETS.find(b=>inc<=b.threshold).rate;

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded',()=>{
            g('individualBtn').addEventListener('click',()=>{coupleMode=false;toggleMode();calculate();});
            g('coupleBtn').addEventListener('click',()=>{coupleMode=true;toggleMode();calculate();});

            document.querySelectorAll('.inflation-toggle').forEach(btn=>{
                btn.addEventListener('click',()=>{inflation=btn.dataset.value==='true';updateToggleButtons();calculate();});
            });

            document.querySelectorAll('.fiscal-toggle').forEach(btn=>{
                btn.addEventListener('click',()=>{fiscalDrag=btn.dataset.value==='true';updateToggleButtons();calculate();});
            });

            // Event toggle handlers
            g('reductionOn').addEventListener('click',()=>{reductionEnabled=true;updateEventUI();g('reductionDetails').style.display='block';calculate();});
            g('reductionOff').addEventListener('click',()=>{reductionEnabled=false;updateEventUI();g('reductionDetails').style.display='none';calculate();});
            g('suspensionOn').addEventListener('click',()=>{suspensionEnabled=true;updateEventUI();g('suspensionDetails').style.display='block';calculate();});
            g('suspensionOff').addEventListener('click',()=>{suspensionEnabled=false;updateEventUI();g('suspensionDetails').style.display='none';calculate();});
            g('homeStartOn').addEventListener('click',()=>{homeStartEnabled=true;updateEventUI();g('homeStartDetails').style.display='block';updateMaxHomeWithdrawal();});
            g('homeStartOff').addEventListener('click',()=>{homeStartEnabled=false;updateEventUI();g('homeStartDetails').style.display='none';calculate();});

            g('addPeriodBtn').addEventListener('click',()=>{reductionPeriods.push({startYear:1,duration:1});renderReductionPeriods();calculate();});
            g('addSuspensionBtn').addEventListener('click',()=>{suspensionPeriods.push({startYear:1,duration:1});renderSuspensionPeriods();calculate();});

            const inputIds=['age','withdrawalAge','memberRate','employerRate','wageGrowth','inflationRate','strategy','strategyShared','strategyPartner','retirementReturn','retirementReturnShared','nzSuperAge','nzSuperAgeShared','nzSuperIndexation','nzSuperIndexationShared','incomeRule','incomeRuleShared','agePartner','withdrawalAgePartner','memberRatePartner','employerRatePartner'];
            inputIds.forEach(id=>{if(g(id)) g(id).addEventListener('change',()=>{updateMaxHomeWithdrawal();calculate();});});

            ['currentBalance','annualIncome','nzSuperAnnual','nzSuperAnnualShared','currentBalancePartner','annualIncomePartner'].forEach(id=>{
                const el=g(id);
                if(el){
                    el.addEventListener('input',()=>el.value=el.value.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,','));
                    el.addEventListener('blur',()=>{updateMaxHomeWithdrawal();calculate();});
                }
            });

            g('resetBtn').addEventListener('click',()=>{
                const ids=['age','withdrawalAge','currentBalance','annualIncome','memberRate','employerRate','strategy','retirementReturn','wageGrowth','inflationRate','nzSuperAge','nzSuperAnnual','agePartner','withdrawalAgePartner','currentBalancePartner','annualIncomePartner','memberRatePartner','employerRatePartner','strategyPartner'];
                const vals=['35','65','5,000','80,000','4','4','balanced','2.0','3.5','2.0','65','26,689','35','65','5,000','80,000','4','4','balanced'];
                ids.forEach((id,i)=>{if(g(id)) g(id).value=vals[i];});
                if(g('nzSuperIndexation')) g('nzSuperIndexation').value='cpi';
                if(g('incomeRule')) g('incomeRule').value='4percent';
                g('homeStartYear').value='5';
                g('homeStartAmount').value='';
                reductionEnabled=suspensionEnabled=homeStartEnabled=false;
                reductionPeriods=[{startYear:1,duration:1}];
                suspensionPeriods=[{startYear:1,duration:1}];
                coupleMode=false;
                fiscalDrag=true;
                inflation=true;
                toggleMode();
                renderReductionPeriods();
                renderSuspensionPeriods();
                calculate();
            });

            renderReductionPeriods();
            renderSuspensionPeriods();
            toggleMode();
            updateMaxHomeWithdrawal();
            calculate();
        });

        function renderReductionPeriods(){
            const container=g('reductionPeriodsContainer');
            container.innerHTML='';
            reductionPeriods.forEach((p,i)=>{
                const d=document.createElement('div');
                d.className='period';
                d.innerHTML=`<div class="period-header"><div class="period-title">Period ${i+1}</div>${reductionPeriods.length>1?`<button type="button" class="remove-period-btn" onclick="removePeriod(${i})">Remove</button>`:''}</div><div class="period-inputs"><div class="form-group"><label>Start Year</label><input type="number" min="1" value="${p.startYear}" onchange="updatePeriod(${i},'startYear',this.value);calculate();"><p class="label-note">1 = next year, 2 = year after, etc.</p></div><div class="form-group"><label>Duration (Years)</label><input type="number" min="1" value="${p.duration}" onchange="updatePeriod(${i},'duration',this.value);calculate();"></div></div>`;
                container.appendChild(d);
            });
        }

        function renderSuspensionPeriods(){
            const container=g('suspensionPeriodsContainer');
            container.innerHTML='';
            suspensionPeriods.forEach((p,i)=>{
                const d=document.createElement('div');
                d.className='period';
                d.innerHTML=`<div class="period-header"><div class="period-title">Suspension ${i+1}</div>${suspensionPeriods.length>1?`<button type="button" class="remove-period-btn" onclick="removeSuspension(${i})">Remove</button>`:''}</div><div class="period-inputs"><div class="form-group"><label>Start Year</label><input type="number" min="1" value="${p.startYear}" onchange="updateSuspension(${i},'startYear',this.value);calculate();"><p class="label-note">1 = next year, 2 = year after, etc.</p></div><div class="form-group"><label>Duration (Years)</label><input type="number" min="1" value="${p.duration}" onchange="updateSuspension(${i},'duration',this.value);calculate();"></div></div>`;
                container.appendChild(d);
            });
        }

        function updatePeriod(i,f,v){if(reductionPeriods[i]) reductionPeriods[i][f]=parseInt(v);}
        function updateSuspension(i,f,v){if(suspensionPeriods[i]) suspensionPeriods[i][f]=parseInt(v);}

        function removePeriod(i){reductionPeriods.splice(i,1);renderReductionPeriods();calculate();}
        function removeSuspension(i){suspensionPeriods.splice(i,1);renderSuspensionPeriods();calculate();}

        function updateEventUI(){
            document.querySelectorAll('#reductionOn, #reductionOff').forEach(b=>{
                const isActive=reductionEnabled;
                b.classList.toggle('active',(b.id==='reductionOn')===isActive);
            });
            document.querySelectorAll('#suspensionOn, #suspensionOff').forEach(b=>{
                const isActive=suspensionEnabled;
                b.classList.toggle('active',(b.id==='suspensionOn')===isActive);
            });
            document.querySelectorAll('#homeStartOn, #homeStartOff').forEach(b=>{
                const isActive=homeStartEnabled;
                b.classList.toggle('active',(b.id==='homeStartOn')===isActive);
            });
        }

        function updateToggleButtons(){
            document.querySelectorAll('.inflation-toggle').forEach(b=>{
                b.classList.toggle('active',(b.dataset.value==='true')===inflation);
            });
            document.querySelectorAll('.fiscal-toggle').forEach(b=>{
                b.classList.toggle('active',(b.dataset.value==='true')===fiscalDrag);
            });
        }

        function toggleMode(){
            g('partnerCard').classList.toggle('visible',coupleMode);
            g('sharedSettingsCard').classList.toggle('visible',coupleMode);
            g('allInputs').classList.toggle('couple',coupleMode);
            g('layoutWrapper').classList.toggle('couple',coupleMode);
            document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
            g(coupleMode?'coupleBtn':'individualBtn').classList.add('active');
            document.querySelectorAll('.individual-only').forEach(el=>{
                el.style.display=coupleMode?'none':'block';
            });
            updateToggleButtons();
            updateEventUI();
        }

        function toggleSection(el){el.classList.toggle('collapsed');el.nextElementSibling.classList.toggle('collapsed');}
        function toggleBreakdown(el){el.classList.toggle('expanded');el.nextElementSibling.classList.toggle('show');}

        function isReductionYear(y,p){for(let period of p){if(y>=period.startYear-1&&y<period.startYear-1+period.duration) return true;}return false;}
        function isSuspensionYear(y,p){for(let period of p){if(y>=period.startYear-1&&y<period.startYear-1+period.duration) return true;}return false;}

        // ===== MONTHLY COMPOUNDING WITH CORRECT TAX TREATMENT =====
        function calcKiwiSaver(a,wa,b,i,mr,er,s,wg,p1,p2,fhYear,fhAmount){
            const pr=getPIETaxRate(i);
            const aR=getRate(s,pr);
            const mR=aR/12;
            const months=(wa-a)*12-1;
            const wR=wg/100;
            const annualInc=i;
            
            const baseEsctRate=getEsctRate(i);
            
            let balance=b;
            let totalMember=0, totalEmployer=0, totalGovt=0, totalReturns=0, fhWithdrawn=0;
            let yearlyMemberContrib=0;
            
            for(let m=0;m<months;m++){
                const y=Math.floor(m/12);
                const monthInYear=m%12;
                
                const yearIncome=annualInc*Math.pow(1+wR,y);
                const monthlyIncome=yearIncome/12;
                
                let mRate=mr, eRate=er;
                if(reductionEnabled&&isReductionYear(y,p1)){mRate=3; eRate=3;}
                if(suspensionEnabled&&isSuspensionYear(y,p2)){mRate=0; eRate=0;}
                
                // Calculate return on opening balance
                const netReturn=balance*mR;
                balance+=netReturn;
                totalReturns+=netReturn;
                
                // Add contributions
                const monthlyIncomeTax=calcIncomeTax(yearIncome)/12;
                const monthlyNetIncome=monthlyIncome-monthlyIncomeTax;
                const memberCont=monthlyNetIncome*mRate/100;
                
                const employerGrossContrib=monthlyIncome*eRate/100;
                const currentEsctRate=fiscalDrag?getEsctRate(yearIncome):baseEsctRate;
                const employerCont=employerGrossContrib*(1-currentEsctRate/100);
                
                balance+=memberCont+employerCont;
                totalMember+=memberCont;
                totalEmployer+=employerCont;
                yearlyMemberContrib+=memberCont;
                
                // Apply government contribution at end of financial year
                if(monthInYear===11){
                    const govtCont=Math.min(yearlyMemberContrib*GOVT_RATE, GOVT_ANNUAL_CAP);
                    balance+=govtCont;
                    totalGovt+=govtCont;
                    yearlyMemberContrib=0;
                }
                
                if(homeStartEnabled&&m+1===fhYear*12){
                    const maxWithdraw=Math.max(0,balance-FIRST_HOME_MIN_REMAINING);
                    fhWithdrawn=Math.min(fhAmount||maxWithdraw,maxWithdraw);
                    balance-=fhWithdrawn;
                }
            }
            
            return {nom:balance,mTot:totalMember,eTot:totalEmployer,gTot:totalGovt,fhWithdrawn:fhWithdrawn};
        }

        function updateMaxHomeWithdrawal(){
            const a=+g('age').value,b=+clean(g('currentBalance').value)||0,i=+clean(g('annualIncome').value)||0;
            const mr=+g('memberRate').value||0,er=+g('employerRate').value||0,s=g('strategy').value;
            const wg=+g('wageGrowth').value||0;
            const fhYear=+g('homeStartYear').value;

            if(!a||!i||!s){
                g('homeStartAmount').value='';
                return;
            }

            const pr=getPIETaxRate(i);
            const aR=getRate(s,pr);
            const mR=aR/12;
            const months=(fhYear-1)*12-1;
            const wR=wg/100;
            const baseEsctRate=getEsctRate(i);
            
            let balance=b;
            let yearlyMemberContrib=0;
            for(let m=0;m<months;m++){
                const y=Math.floor(m/12);
                const monthInYear=m%12;
                const yearIncome=i*Math.pow(1+wR,y);
                const monthlyIncome=yearIncome/12;
                
                const netReturn=balance*mR;
                balance+=netReturn;
                
                const monthlyIncomeTax=calcIncomeTax(yearIncome)/12;
                const monthlyNetIncome=monthlyIncome-monthlyIncomeTax;
                const memberCont=monthlyNetIncome*mr/100;
                
                const employerGrossContrib=monthlyIncome*er/100;
                const currentEsctRate=fiscalDrag?getEsctRate(yearIncome):baseEsctRate;
                const employerCont=employerGrossContrib*(1-currentEsctRate/100);
                
                balance+=memberCont+employerCont;
                yearlyMemberContrib+=memberCont;
                
                if(monthInYear===11){
                    const govtCont=Math.min(yearlyMemberContrib*GOVT_RATE, GOVT_ANNUAL_CAP);
                    balance+=govtCont;
                    yearlyMemberContrib=0;
                }
            }
            
            const maxWithdraw=Math.max(0,balance-FIRST_HOME_MIN_REMAINING);
            g('homeStartAmount').value=maxWithdraw>0?fmt(maxWithdraw):'$0.00';
        }

        function calculate(){
            const a=+g('age').value,wa=+g('withdrawalAge').value,b=+clean(g('currentBalance').value)||0,i=+clean(g('annualIncome').value)||0;
            const mr=+g('memberRate').value||0,er=+g('employerRate').value||0,s=g('strategy').value;
            const nza=+g('nzSuperAge').value||65,nzv=+clean(g('nzSuperAnnual').value)||0,nzi=g('nzSuperIndexation').value,ir=g('incomeRule').value;
            const rr=+g('retirementReturn').value||0,wg=+g('wageGrowth').value||0,inf=+g('inflationRate').value||0;
            const fhYear=+g('homeStartYear').value,fhAmount=g('homeStartAmount').value?+clean(g('homeStartAmount').value):0;

            g('errorMessage').innerHTML='';
            if(!a||!wa||!i||!s){g('resultsContent').style.display='none';g('resultsPlaceholder').style.display='block';return;}
            if(wa<60||wa<=a){g('errorMessage').innerHTML='<div class="error">⚠️ Invalid age range</div>';g('resultsContent').style.display='none';g('resultsPlaceholder').style.display='block';return;}

            const iR=inf/100,rR=rr/100,wR=wg/100;
            const ks=calcKiwiSaver(a,wa,b,i,mr,er,s,wg,reductionPeriods,suspensionPeriods,fhYear,fhAmount);
            const nom=ks.nom,mTot=ks.mTot,eTot=ks.eTot,gTot=ks.gTot,fhWithdrawn=ks.fhWithdrawn;
            const yrs=wa-a;
            const real=nom/Math.pow(1+iR,yrs),rmTot=mTot/Math.pow(1+iR,yrs),reTot=eTot/Math.pow(1+iR,yrs),rgTot=gTot/Math.pow(1+iR,yrs);
            const d=inflation?real:nom,ds=inflation?b:b*Math.pow(1+iR,yrs),dm=inflation?rmTot:mTot,de=inflation?reTot:eTot,dgg=inflation?rgTot:gTot;
            const dFh=inflation?fhWithdrawn/Math.pow(1+iR,yrs):fhWithdrawn;
            const r=d-ds-dm-de-dgg;

            g('breakdownStarting').textContent=fmt(ds);g('breakdownMember').textContent=fmt(dm);g('breakdownEmployer').textContent=fmt(de);g('breakdownGovernment').textContent=fmt(dgg);g('breakdownReturns').textContent=fmt(Math.max(0,r));
            const hsi=g('homeStartBreakdownItem');
            if(homeStartEnabled&&dFh>0){hsi.style.display='flex';g('breakdownHomeStart').textContent=fmt(dFh);}else{hsi.style.display='none';}

            const ys=nza-a;
            let idxNz=nzv;
            if(ys>0){
                if(nzi==='cpi')idxNz=nzv*Math.pow(1+iR,ys);
                else if(nzi==='wage')idxNz=nzv*Math.pow(1+wR,ys);
                else if(nzi==='hybrid')idxNz=nzv*Math.pow(1+(wR+iR)/2,ys);
            }
            g('nzSuperValue').textContent=fmt(idxNz);
            let desc='';
            if(nzi==='none')desc=`Static: ${fmt(nzv)}`;
            else if(nzi==='cpi')desc=`CPI ${inf}% p.a.: ${fmt(nzv)}→${fmt(idxNz)} at age ${nza}`;
            else if(nzi==='wage')desc=`Wage ${wg}% p.a.: ${fmt(nzv)}→${fmt(idxNz)} at age ${nza}`;
            else if(nzi==='hybrid')desc=`Hybrid: ${fmt(nzv)}→${fmt(idxNz)} at age ${nza}`;
            g('nzSuperIndexationDetails').textContent=desc;

            const y64=64-a,inc64=i*Math.pow(1+wR,y64);
            let html='';
            for(let ar=65;ar<=90;ar++){
                const yf=ar-wa,nom64=nom*Math.pow(1+rR,Math.max(0,yf)),real64=nom64/Math.pow(1+iR,Math.max(0,yf)),db=inflation?real64:nom64;
                let ks_val=0;
                if(ar>=wa){
                    if(ir==='4percent')ks_val=db*.04*Math.pow(1+iR,Math.max(0,yf));
                    else if(ir==='6percent')ks_val=db*.06;
                    else ks_val=db/(90-ar);
                }
                let nzs=0;
                if(ar>=nza){
                    const yn=ar-nza;
                    let idx=idxNz;
                    if(nzi==='none')idx=nzv;
                    else if(nzi==='cpi')idx=nzv*Math.pow(1+iR,yn);
                    else if(nzi==='wage')idx=nzv*Math.pow(1+wR,yn);
                    else if(nzi==='hybrid')idx=nzv*Math.pow(1+(wR+iR)/2,yn);
                    nzs=coupleMode?idx/2:idx;
                }
                const t=ks_val+nzs,rep=inc64>0?(t/inc64)*100:0;
                html+=`<tr><td>${ar}</td><td>${fmt(ks_val)}</td><td>${fmt(nzs)}</td><td>${fmt(t)}</td><td>${rep.toFixed(1)}%</td></tr>`;
            }
            g('incomeTable').innerHTML=html;

            if(coupleMode){
                const ap=+g('agePartner').value,wap=+g('withdrawalAgePartner').value,bp=+clean(g('currentBalancePartner').value)||0,ip=+clean(g('annualIncomePartner').value)||0;
                const mrp=+g('memberRatePartner').value||0,erp=+g('employerRatePartner').value||0,sp=g('strategyPartner').value;
                const ksp=calcKiwiSaver(ap,wap,bp,ip,mrp,erp,sp,wg,[],[],0,0);
                const iR_partner=inf/100;
                const realp=ksp.nom/Math.pow(1+iR_partner,wap-ap),dp=inflation?realp:ksp.nom;
                const ba=+g('projectedBalance').textContent.replace(/[^0-9.-]/g,'');
                g('projectedBalancePartner').textContent=fmt(dp);g('withdrawalAgeDisplayPartner').textContent=wap;g('combinedBalance').textContent=fmt(ba+dp);g('coupleResults').classList.add('visible');
            }else g('coupleResults').classList.remove('visible');

            g('projectedBalance').textContent=fmt(d);g('withdrawalAgeDisplay').textContent=`At age ${wa}`;g('resultsContent').style.display='block';g('resultsPlaceholder').style.display='none';
        }
    </script>
</body>
</html>
